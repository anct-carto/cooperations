<!DOCTYPE html>
<html>

<head>

	<!-- Développement : service cartographie du CGET -->

    <meta charset="utf-8" />
    <title>Coopérations</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" type="image/png" href="img/picto_favicon.png"/>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" />
    <link rel="stylesheet" href="src/leaflet-sidebar.css" />
	<link rel="stylesheet" href="src/leaflet-search.css" />
	<link href="https://fonts.googleapis.com/css?family=Asap:400,400i,500,500i,600,600i,700,700i|Crimson+Text:400,400i,600,600i,700,700i" rel="stylesheet">
	<link rel="stylesheet" href="style.css" />
	<link rel="stylesheet" href="style_menu.css" />
	
</head>
	


<body>
	
	<!-- Construction de panneau latéral -->
    <div id="sidebar" class="sidebar collapsed">
        
		 <!-- Boutons de menu -->
		<div class="sidebar-tabs" id="barre-verticale">
            <ul role="tablist" >
                <li onmouseover="document.getElementById('tip1').style.opacity = '1'" onmouseout="document.getElementById('tip1').style.opacity = '0'"><a href="#home" role="tab" id="logo" title="Retour à l'accueil" class="onglets"><i style="vertical-align:middle;" class="fas fa-home"></i></a></li>
					<div class="tip "id="tip1">Retour à l'accueil</div>
				<li onmouseover="document.getElementById('tip2').style.opacity = '1'" onmouseout="document.getElementById('tip2').style.opacity = '0'"><a href="https://cartotheque.cget.gouv.fr/cartes" id="cartes_ref" role="tab" target="_blank" title="Cartes de référence" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-map"></i></a></li>
					<div class="tip "id="tip2">Cartes de référence</div>
				<li onmouseover="document.getElementById('tip3').style.opacity = '1'" onmouseout="document.getElementById('tip3').style.opacity = '0'"><a href="" id="recherche" role="tab" target="_blank" title="Rechercher" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-search"></i></a></li>
					<div class="tip "id="tip3">Module de recherche</div>
				<li onmouseover="document.getElementById('tip4').style.opacity = '1'" onmouseout="document.getElementById('tip4').style.opacity = '0'"><a href="https://www.youtube.com" id="videos" role="tab" target="_blank" title="témoignages" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-play-circle"></i></a></li>
					<div class="tip "id="tip4">Témoignages vidéos</div>
				<li onmouseover="document.getElementById('tip5').style.opacity = '1'" onmouseout="document.getElementById('tip5').style.opacity = '0'"><a href="https://www.data.gouv.fr/fr/" id="data" role="tab" target="_blank" title="jeux de données" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-database"></i></a></li>
					<div class="tip "id="tip5">Jeux de données</div>
				<li onmouseover="document.getElementById('tip6').style.opacity = '1'" onmouseout="document.getElementById('tip6').style.opacity = '0'"><a href="https://www.pagesjaunes.fr/pagesblanches" id="annuaire" role="tab" target="_blank" title="annuaire" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-address-book"></i></a></li>
					<div class="tip "id="tip6">Annuaire</div>
				<li onmouseover="document.getElementById('tip7').style.opacity = '1'" onmouseout="document.getElementById('tip7').style.opacity = '0'"><a href="img/mecenat.png" id="mecenat" role="tab" target="_blank" title="mecenat" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa">$</i></a></li>
					<div class="tip "id="tip7">Mécénat de compétences</div>
			</ul>
        </div>

        <!-- Contenu des onglets -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                
				<h1>Carte interactive des coopérations interterritoriales
				<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
				
				<!-- Page d'accueil -->
				<div class="presentation" id="defaut">
					
					<ul id="menu_themes">
						<li><a href="#">Sélectionner les coopérations par thème</a>
							<ul id="liste_themes">
								<li><a href="#">lien sous menu 1</a></li>
								<li><a href="#">lien sous menu 1</a></li>
								<li><a href="#">lien sous menu 1</a></li>
								<li><a href="#">lien sous menu 1</a></li>
							</ul>
						</li>
					</ul>
					
					<div>
						<h2>Les objectifs du portail des coopérations interterritoriales</h2>
						<p style="color:#fff;" onclick="test();">Remplit le menu déroulant</p>
						<p>Le recensement des coopérations entre les Métropoles et les territoires environnants, réalisé en mars 2019, a permis d’établir que ces coopérations sont une réalité, sur l’ensemble du territoire national. Il apparaît maintenant nécessaire de <strong>donner à voir ces coopérations, de manière  quantitative et qualitative</strong>, mais aussi <strong>d’étendre le spectre</strong> de manière à inclure toutes les coopérations interterritoriales, bien au-delà des coopérations impliquant des Métropoles.</p>
						<p>Il s’agit également <strong>d’animer une « communauté d’acteurs »</strong>, porteurs de coopérations interterritoriales ou promoteurs de ces démarches, et de <strong>faciliter les échanges entre eux.</strong></p>
						<p>Enfin, <strong>outiller</strong> les acteurs sur le plan des données et plus largement de <strong>l’observation des dynamiques interterritoriales</strong> se dégage comme un enjeu fort. Si des travaux existent d’ores et déjà en la matière, produits notamment par les agences d’urbanisme, certains flux et échanges entre les territoires sont encore peu documentés, mesurés, or des données existent et des méthodes d’analyse de celles-ci se développent.</p>
					</div>
					
					<div id="sources" style="width:100%;">
						<p><i>Sources des données&nbsp;: <a href="https://www.cget.gouv.fr/territoires/metropoles" class="hyperlien" target="_blank">CGET, Direction des stratégories territoriales,</a> • Réalisation&nbsp;: bureau de la prospective et des études, <a href="https://cartotheque.cget.gouv.fr/cartes?filters%5Bquery%5D=interactif&current_page=1&category=&page_size=20" class="hyperlien" target="_blank">CGET service cartographie</a></i></p>
						<p><img src="img/cget.png" style="vertical-align:middle; width:70%;"/></p>
					</div>
				</div>
				
				<!-- Contenu de la fiche d'information sur les territoires -->
				<div class="divTable" id="popup">
					
					<h3 class="divTableRow">Territoire</h3>
					<h2 class="territoire" id="libgeo"></h2>
					
					<div class="">
						<h3 class="">Liste des coopérations dans lequel ce territoire est impliqué&nbsp;:</h3>
						<div class="description cooperation" id="liste_cooperations"></div>
						
						<div class="retour"><img src='img/fleche.png' style='vertical-align:middle; width:20px; padding:0px 15px;'  />Retour</div>
					</div>	
				</div>
				
				<!-- Contenu de la fiche d'information sur les coopérations -->
				<div class="divTable" id="coop">
					
					<h3 class="divTableRow">Coopération</h3>
					<h2 class="cooperation" id="nom_coop"></h2>
					
					<div class="divTableBody">
						<div class="divTableCell">
								<h3 class="divTableRow">Objectifs de la coopération</h3>
								<div class="divTableRow description" id="objectif"></div>
						</div>
						
						<div class="divTableCell">
								<h3 class="divTableRow">Thématiques</h3>
								<div class="divTableRow description" id="thematiques"></div>
						</div>
						
						<div class="divTableCell">
								<h3 class="divTableRow">Modalité</h3>
								<div class="divTableRow description" id="modalite"></div>
						</div>
						
						<div class="divTableCell">
								<h3 class="divTableRow">liste des territoires impliqués dans la coopération annoncés dans le tableau</h3>
								<div class="divTableRow description" id="territoires"></div>
						</div>
						
						<div class="divTableCell">
								<h3 class="divTableRow">liste des territoires impliqués dans la coopération</h3>
								<div class="divTableRow description territoire" id="liste_territoires"></div>
						</div>
						
						<div class="retour"><img src='img/fleche.png' style='vertical-align:middle; width:20px; padding:0px 15px;'  />Retour</div>
					</div>	
				</div>
					
            </div>

        </div>
    </div>
	
	<!-- Définition indicateur 
	<div id="tip">
		<p>Le <strong>potentiel financier</strong> remplace à partir de 2005 le potentiel fiscal comme élément de <strong>mesure de la richesse théorique d’une commune.</strong></p>
			</div>-->
	<!-- Bloc de la carte -->
	
	<div id="mapid"></div>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
	
    <script src="src/leaflet-sidebar.js"></script>
	<script src="src/leaflet-search.js"></script>
	<script src="src/randomColor-master/randomColor.js"></script>
	<script type="text/javascript"  src="https://unpkg.com/leaflet.vectorgrid@1.2.0"></script>
	<script type="text/javascript" src="data/territoires.js"></script>
	<script type="text/javascript" src="data/masque.js"></script>
	<script type="text/javascript" src="data/toutesCouches_gen.js"></script>
	<script type="text/javascript" src="data/cercles_drom.js"></script>
    
	<script>
			
		// Création de la carte
		var map = L.map('mapid', {maxZoom:10, minZoom:5 })
		.setView([46.5, -1.8], 6);
		map.zoomControl.setPosition('topright');
		map.attributionControl.addAttribution('<a href="https://cartotheque.cget.gouv.fr/cartes" style="text-decoration:none;" target="_blank ">CGET</a>');
			
		//Ajout du panneau latéral
		var sidebar = L.control.sidebar('sidebar').addTo(map);
		sidebar.open('home');
		
		//Reglage double-clic
		var timer = 0;
		var delay = 200;
		var prevent = false;
		
/* COULEURS - STYLES - LEGENDE */
		
		//une couleur unique pour chaque territoire
		var couleur;
		var hue = '';
		function getColor(metropole) {
		console.log(metropole);
			if (metropole.includes("brest")) {hue = 'blue';}
			else if (metropole.includes("bordeaux")) {hue = 'green';}
			else if (metropole.includes("cooperation")) {hue = 'pink';}
			couleur = randomColor({ 
				hue : hue,
				luminosity: 'dark', //bright light dark
				format: 'hex' // rgb rgba rgbArray hsl hsla hslArray hex
				});
			return couleur;
		}
		
/* CREATION DES COUCHES */		
		
		//Niveaux d'affichage des couches
		map.createPane('fond');
		map.getPane('fond').style.zIndex = 500;
		map.createPane('contour');
		map.getPane('contour').style.zIndex = 500;
		map.createPane('cercles');
		map.getPane('cercles').style.zIndex = 510;
		map.createPane('metro');
		map.getPane('metro').style.zIndex = 520;
		map.createPane('metCible2');
		map.getPane('metCible2').style.zIndex = 525;
		map.createPane('metCible');
		map.getPane('metCible').style.zIndex = 530;
		map.createPane('lines');
		map.getPane('lines').style.zIndex = 535;
		
		
		//Couches du fond de carte
		Cache = L.geoJSON(JS_masque, {color: "#f0f2f6", weight: 0, opacity: 1, fillOpacity: 1, pane: "fond"}).addTo(map);
		Cercles_drom = L.geoJSON(JS_drom, {color: "#ffffff", weight: 0.9, opacity: 1, fillOpacity: 0, pane: "cercles"}).addTo(map);
		
		Fond_Regions = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="région"},
			style : {weight: 0, opacity: 1, fillOpacity: 1, fillColor:"#bfbfbf", pane: "fond"}
			}).addTo(map);
		
		Contour_Regions = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="région"},
			style : {color: "#ffffff", weight: 1.3, opacity: 1, fillOpacity: 0, pane: "contour"}
			}).addTo(map);
		
		Departements = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="départemen"},
			style: {color: "#ffffff", weight: 0.5, opacity: 1, fillOpacity: 0, pane: "contour"}
			}).addTo(map);
		
		ZAU = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="zau"},
			style: function(feature){
				if (feature.properties.codgeo=="120"){
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#cccccc", pane: "fond"};
				}
				else if (feature.properties.codgeo=="112"){
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#bfbfbf", pane: "fond"};
				}
				else if (feature.properties.codgeo=="111"){
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#aeaeae", pane: "fond"};
				}
				else {
					return {opacity: 1, fillOpacity: 1, weight: 0, color:"#d4d4d4", pane: "fond"};
				}
			}
		})
		//.addTo(map);
		
		//Territoires
		Territoires = L.geoJSON(JS_territoires, {
			//filter: function(feature, layer) {return feature.properties.type=="départemen"},
			style: function(feature){return { color: "white", weight: 0.5, opacity: 0.9, fillOpacity: 1, pane: "metro", fillColor: getColor(feature.properties.id_terr)};},
			onEachFeature: function(feature, layer) {		
				layer.bindTooltip(feature.properties.nom_maille, {className: 'TooltipsTerr Tooltips', direction: "center"});
				layer.on('click', function(e) {	
					popup(feature.properties); 
					metropoleCible(e.target._latlngs);
					//polylineCoop.clearLayers();
					e.preventDefault();					
					});	
				layer.on('mouseover', function(e) {	
					metropoleCibleHover(e.target, 'objet'); 
					});	
				layer.on('mouseout', function(e) {	
					if(metCibHover) {map.removeLayer(metCibHover);}
					terrLayer.clearLayers();
					});	
				}
			}).addTo(map);
		
		//Aller chercher le tableau des correspondances
		var listeTerrCoop = [];
		function creerListeTerrCoop() {
			fetch("data/terr_coop.json")
				.then(response=>response.json())
				.then(response=>{
					for (var i = 0; i < response.length; i++) {
						listeTerrCoop.push(response[i])
						}
					});
		}
		creerListeTerrCoop();
		
		//Aller chercher le tableau des coopérations
		var listeCooperations = [];
		function creerCoop(e) {
			fetch("data/cooperations.json")
				.then(response=>response.json())
				.then(response=>{
					for (var i = 0; i < response.length; i++) {
						listeCooperations.push(response[i])
						}
					});
		
		}
		creerCoop();
		
		//Aller chercher le tableau des thèmes et remplir le menu déroulant avec
		var listeThemes = [];
		function creerThemes(e) {
			fetch("data/themes.json")
				.then(response=>response.json())
				.then(response=>{
					for (var i = 0; i < response.length; i++) {
						listeThemes.push(response[i]);
						document.getElementById("liste_themes").innerHTML += "</br>" + response[i];		
						}	
					});
			test();
		}
		creerThemes();
		
		//couches d'action de sélection
		var metCib = [];
		function metropoleCible(e){ 
			if(metCib) {map.removeLayer(metCib);}
			metCib = L.polygon(e, {interactive:false, opacity: 1, fillOpacity: 1, fillColor: 'yellow', weight: 1, color: '#3b4358', pane: "metCible2"}).addTo(map);
		}
		
		var metCibHover = [];
		function metropoleCibleHover(e, type){ 
			if(metCibHover) {map.removeLayer(metCibHover);}
			if (type == 'objet'){metCibHover = L.polygon(e._latlngs, {fillOpacity: 0.7, fillColor: 'yellow', interactive:false, color: 'white',pane: "metCible", weight:2}).addTo(map);}
			else if (type == 'xy'){ metCibHover = L.polygon(e, {fillOpacity: 0.7, fillColor: 'yellow', interactive:false, color: 'white',pane: "metCible", weight:2}).addTo(map);}
			//terrImpliques(e.feature.properties.id_terr);
		}
		
		/*Afficher la connexion entre les territoires
		var coopArray = [];
		var terrArray = [];
		var terrLayer = new L.layerGroup();
		function terrImpliques(e) {
			terrArray = []; coopArray = [];
			//Lire la table des correspondances pour tirer la liste des coopérations dans lesquelles le territoire est impliqué
			for (var i = 0; i < listeTerrCoop.length; i++) {
				if (e == listeTerrCoop[i].id_territoire) {
					coopArray.push(listeTerrCoop[i].id_coop);
				}
			}
			//Lire les coopérations trouvées et aller chercher tous les territoires qui sont impliqués dans celles-ci
			for (var j = 0; j < coopArray.length; j++) {
				for (var i = 0; i < listeTerrCoop.length; i++) {
					if (coopArray[j] == listeTerrCoop[i].id_coop && listeTerrCoop[i].id_territoire!= e) {
						terrArray.push(listeTerrCoop[i].id_territoire);
						returnCoords(listeTerrCoop[i].id_territoire);
						polygon = new L.polygon(coords, {fillOpacity: 0.5, fillColor: '#fffbdc', interactive:false, color: 'yellow', pane: "metCible", weight:0.1})
						polygon.addTo(terrLayer);
					}
					
				}
			}
			terrLayer.addTo(map);
		}*/
		
		//Afficher la connexion entre les territoires
		var terrLayer = new L.layerGroup();
		function terrImpliques(e) {
			//Lire la table des correspondances pour tirer la liste des coopérations dans lesquelles le territoire est impliqué
			for (var i = 0; i < listeTerrCoop.length; i++) {
				if (e == listeTerrCoop[i].id_coop) {
					polygon = new L.polygon(returnCoords(listeTerrCoop[i].id_territoire), {fillOpacity: 0.5, fillColor: '#8a2655', interactive:false, pane: "metCible", weight:0.2, color: 'white'});
					polygon.addTo(terrLayer);
				}
				terrLayer.addTo(map);
			}
		}
		
		//aficher les liens inter-territoriaux d'une coopération
		var centroidArray = [];
		var polyline = {};
		var polylineCoopHeavy = new L.layerGroup();
		polylineCoopHeavy.addTo(map);
		var polylineCoopThin = new L.layerGroup();
		polylineCoopThin.addTo(map);
		function drawLines(e,type) {
			centroidArray = [];
			for (var i = 0; i < listeTerrCoop.length; i++) {
				if (e == listeTerrCoop[i].id_coop){
					centroidArray.push(returnCentroid(listeTerrCoop[i].id_territoire));
					//metropoleCibleHover(returnCoords(listeTerrCoop[i].id_territoire), 'xy')
					terrImpliques(listeTerrCoop[i].id_territoire);
					}
				}
				if(type=="thin"){
					polylineCoopThin.clearLayers();
					polyline[e] = L.polyline(centroidArray, {color: getColor('cooperation'), weight:2, opacity:0.7, pane: "lines"});
					polyline[e].addTo(polylineCoopThin);	
					}
				else if (type=="heavy"){
					//polylineCoopHeavy.clearLayers();
					polyline[e] = L.polyline(centroidArray, {color: getColor('cooperation'), weight:3, pane: "lines"});
					polyline[e].addTo(polylineCoopHeavy);
					polyline[e].on('click', function(){showCoop(e);});
					polyline[e].bindTooltip(returnCoopObject(e).nom_coop, {className: 'TooltipsCoop Tooltips', direction: "center", sticky: "true"});
					}
				polyline[e].properties = {};
				polyline[e].properties.id_coop = e;
		}
		
		function filtre(e) {
			for (var i = 0; i < listeCooperations.length; i++) {
				if (listeCooperations[i].theme_dom.includes(e)) {
					drawLines(listeCooperations[i].id_coop,'heavy');
				}
			}
		}
		
		function test() {
			for (var i = 0; i < listeThemes.length; i++) {
				document.getElementById("liste_themes").innerHTML +=
					"<li><a href='#'>"+listeThemes[i].nom_theme+"</a></li>";		
				}
		}
		
		
/* FICHES TERRITOIRES ET COOPERATIONS */
		
		//Création d'une fiche territoire
		function popup(e) {
			if (document.getElementById('sidebar').classList.contains('collapsed')){sidebar.open('home');}
			document.getElementById('popup').style.display = "block";
			document.getElementById('defaut').style.display = "none";
			document.getElementById('coop').style.display = "none";
			polylineCoopHeavy.clearLayers();
			
			//Remplissage de la popup
				//Infos sur le territoire
				document.getElementById('libgeo').innerHTML = e.nom_maille;	
			
			//Liste des coopérations
				document.getElementById('liste_cooperations').innerHTML = "<div>";
				for (var i = 0; i < listeTerrCoop.length; i++) {
				
					if(e.id_terr == listeTerrCoop[i].id_territoire){
						document.getElementById("liste_cooperations").innerHTML +=
							"<div class='liste	'" +
							"onclick='showCoop(\"" +listeTerrCoop[i].id_coop+"\"); drawLines(\""+listeTerrCoop[i].id_coop+"\", \"heavy\");'" +
							"onmouseover='drawLines(\""+listeTerrCoop[i].id_coop+"\", \"thin\"); terrImpliques(\""+listeTerrCoop[i].id_coop+"\")'" +
							"onmouseout='polylineCoopThin.clearLayers(); terrLayer.clearLayers();'>" +
							"&rarr; " + jointure(listeTerrCoop[i].id_coop, 'terr-coop' ,'nom_coop') + "</div>" ;
					}
				}
				document.getElementById('liste_cooperations').innerHTML += "</div>";
				
		}
		
		//Afficher la fiche des coopérations
		function showCoop(e) {
			document.getElementById('coop').style.display = "block";
			document.getElementById('defaut').style.display = "none";
			document.getElementById('popup').style.display = "none";
			if(metCib) {map.removeLayer(metCib);}
			if(metCibHover) {map.removeLayer(metCibHover);}
			
			//Infos sur la coopération
			document.getElementById('nom_coop').innerHTML = jointure(e,'terr-coop','nom_coop');
			document.getElementById('objectif').innerHTML = jointure(e,'terr-coop','objectif');
			document.getElementById('thematiques').innerHTML = jointure(e,'terr-coop','thematique');
			document.getElementById('modalite').innerHTML = jointure(e,'terr-coop','modalite');
			document.getElementById('territoires').innerHTML = jointure(e,'terr-coop','liste_territoire');
			
			//Liste des territoires impliqués
				document.getElementById('liste_territoires').innerHTML = "<div>";
				for (var i = 0; i < listeTerrCoop.length; i++) {
					if(e == listeTerrCoop[i].id_coop){
						document.getElementById("liste_territoires").innerHTML +=
						"<div class='liste'" +
						"onMouseover='metropoleCibleHover(returnCoords(\""+listeTerrCoop[i].id_territoire+"\"), \"xy\");'" +
						"onMouseout='map.removeLayer(metCibHover);'" +
						"onclick='showTerr(\""+listeTerrCoop[i].id_territoire+"\");'>" +
						"&rarr; " + jointure(listeTerrCoop[i].id_territoire, 'coop-terr', 'nom_terr') +"</div>" ;
					}
				}
				document.getElementById('liste_territoires').innerHTML += "</div>";
			}
		
		//Affiche la popup et sélectionne un territoire à partir de la liste dans la fiche des coopérations
		var coordsSelect;
		function showTerr(e) {
			Territoires.eachLayer(function(layer){
				if(e == layer.feature.properties.id_terr){
					popup(layer.feature.properties);
				}
			});
			coordsSelect = returnCoords(e);
			metropoleCible(coordsSelect);
		}
		
		//crée le centroïde à partir de coordonnées latlngs
		var centroid;
		function returnCentroid(e) {
			Territoires.eachLayer(function(layer){
				if(e == layer.feature.properties.id_terr){
					centroid = layer.getBounds().getCenter();
				}
			});
			return centroid;
		}
		
	
/* ACTIONS */
		
		//Retourne les coordonnées à partir d'un identifiant de territoire
		var coords;
		function returnCoords(e) {
			Territoires.eachLayer(function(layer){
				if (layer.feature.properties.id_terr == e) {
					coords = layer._latlngs;
					}
			});
			return coords;
		}
		
		//Retourne l'objet coopérations à partir de l'identifiant de la coopération
		var coopObjet;
		function returnCoopObject(e) {
			for (var i = 0; i < listeCooperations.length; i++) {
				if(e == listeCooperations[i].id_coop){
					coopObjet = listeCooperations[i];
					}
			}
			return coopObjet;
			//console.log(coopObjet);
		}
		
		//Jointures liste des coopérations et tableau de correspondances
		var resultat ;
		function jointure(e,sens,champ) {
				if (sens == "terr-coop" ) {
					for (var i = 0; i < listeCooperations.length; i++) {
						if(e == listeCooperations[i].id_coop){
								if (champ == "nom_coop"){resultat = listeCooperations[i].nom_coop}
								if (champ == "objectif"){resultat = listeCooperations[i].objectif; }
								if (champ == "liste_territoire"){resultat = listeCooperations[i].liste_territoire}
								if (champ == "thematique"){resultat = listeCooperations[i].thematique}	
								if (champ == "modalite"){resultat = listeCooperations[i].modalite}
							}
					}
				}
				if (sens == "coop-terr" ) {
					Territoires.eachLayer(function(layer){
						if(e == layer.feature.properties.id_terr){
							if (champ == "nom_terr"){resultat = layer.feature.properties.nom_maille}
						}
					});
				}	
		return resultat ;				
		}
		
		
		// Fonctions générales de navigation
		function resetView() {
			map.setView([46.5, -1.8], 6);		
		}
		
		function resetMap () {
			sidebar.open('home');
			}
			
		function retourAcceuil () {
			resetView();
			resetMap ();
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			document.getElementById('coop').style.display = "none";
			polylineCoopHeavy.clearLayers();
		}
		
		//Action au clic sur "retour"
		var boutons_retour = document.getElementsByClassName("retour");
		for (var i = 0; i < boutons_retour.length; i++) {
			boutons_retour[i].addEventListener('click', retourAcceuil, false);
		}
		
		//Action au clic sur la carte
		map.on('click', function(e) { 
			if(metCib) {map.removeLayer(metCib);}
			if(metCibHover) {map.removeLayer(metCibHover);}
			//retourAcceuil();
			event.stopPropagation();
			
			});
		
		//Action au clic sur "home"
		document.getElementById("logo").addEventListener("click", function(event){
			event.stopPropagation();
			retourAcceuil();
		});

/* BARRE DE RECHERCHE */	
		
		//Barre de recherche n°2 (en haut à droite)
		var searchControl2 = new L.control.search({
			layer: Territoires,
			initial: false,
			position:'topright',
			propertyName: 'nom_maille',
			collapsed: true,
			marker: false,
			moveToLocation: function(latlng, title, map) {
				map.setView(latlng, 8);
			}
		})
		
		searchControl2.on('search:locationfound', function(e) {
			if(metCib) {map.removeLayer(metCib);}
			metropoleCible(e.layer._latlngs);
			popup(e.layer.feature.properties);
		});
		
		map.addControl(searchControl2);	
		
   </script>
	
</body>

</html>
