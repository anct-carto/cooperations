<!DOCTYPE html>
<html>

<head>

	<!-- Développement : service cartographie du CGET -->

    <meta charset="utf-8" />
    <title>Coopérations</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" type="image/png" href="img/picto_favicon.png"/>
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" />
    <link rel="stylesheet" href="src/leaflet-sidebar.css" />
	<link rel="stylesheet" href="src/leaflet-search.css" />
	<link href="https://fonts.googleapis.com/css?family=Asap:400,400i,500,500i,600,600i,700,700i|Crimson+Text:400,400i,600,600i,700,700i" rel="stylesheet">
	<link rel="stylesheet" href="style.css" />
	<link rel="stylesheet" href="style_menu2.css" />
	
</head>
	


<body>
	
	<!-- Construction de panneau latéral -->
    <div id="sidebar" class="sidebar collapsed">
        
		 <!-- Boutons de menu -->
		<div class="sidebar-tabs" id="barre-verticale">
            <ul role="tablist" >
                <li onmouseover="document.getElementById('tip1').style.display = 'block'" onmouseout="document.getElementById('tip1').style.display = 'none'"><a href="#home" role="tab" id="logo" title="Retour à l'accueil" class="onglets"><i style="vertical-align:middle;" class="fas fa-home"></i></a></li>
					<div class="tip "id="tip1">Retour à l'accueil</div>
				<li onmouseover="document.getElementById('tip2').style.display = 'block'" onmouseout="document.getElementById('tip2').style.display = 'none'"><a href="https://cartotheque.cget.gouv.fr/cartes" id="cartes_ref" role="tab" target="_blank" title="Cartes de référence" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-map"></i></a></li>
					<div class="tip "id="tip2">Cartes de référence</div>
				<li onmouseover="document.getElementById('tip3').style.display = 'block'" onmouseout="document.getElementById('tip3').style.display = 'none'"><a id="info" role="tab" target="_blank" title="infos" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-question"></i></a></li>
					<div class="tip "id="tip3">En savoir plus</div>
				<li onmouseover="document.getElementById('tip4').style.display = 'block'" onmouseout="document.getElementById('tip4').style.display = 'none'"><a href="https://www.youtube.com" id="videos" role="tab" target="_blank" title="témoignages" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-play-circle"></i></a></li>
					<div class="tip "id="tip4">Témoignages vidéos</div>
				<li onmouseover="document.getElementById('tip5').style.display = 'block'" onmouseout="document.getElementById('tip5').style.display = 'none'"><a href="https://www.data.gouv.fr/fr/" id="data" role="tab" target="_blank" title="jeux de données" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-database"></i></a></li>
					<div class="tip "id="tip5">Jeux de données</div>
				<li onmouseover="document.getElementById('tip6').style.display = 'block'" onmouseout="document.getElementById('tip6').style.display = 'none'"><a href="https://www.pagesjaunes.fr/pagesblanches" id="annuaire" role="tab" target="_blank" title="annuaire" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa fa-address-book"></i></a></li>
					<div class="tip "id="tip6">Annuaire</div>
				<li onmouseover="document.getElementById('tip7').style.display = 'block'" onmouseout="document.getElementById('tip7').style.display = 'none'"><a href="img/mecenat.png" id="mecenat" role="tab" target="_blank" title="mecenat" class="onglets hyperlien"><i style="vertical-align:middle;" class="fa">$</i></a></li>
					<div class="tip "id="tip7">Mécénat de compétences</div>
			</ul>
        </div>

        <!-- Contenu des onglets -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                
				<h1>Carte interactive des coopérations interterritoriales
				<span class="sidebar-close"><i class="fa fa-caret-left"></i></span>
                </h1>
				
				<!-- Page d'accueil -->
				<div class="presentation" id="defaut">
					
					<div onclick="test();">appui</div>
					
					<div class="divTableCell"  >
						<h3 class="">Rechercher une coopération ou un territoire par son nom&nbsp;:</h3>
						<div id="boiteRecherche"></div>
						<h3 class=""></br></br></h3>
						
					</div>
					
					<div class="divTableCell">
					<h3 class="">Filtrer les coopérations&nbsp;:</h3>
					<ul id="menu_themes" class="menu">
						<li><a id="selectionner_theme">Tous les thèmes</a><span><i class="fa fa-caret-down" style="font-size:1.2em;"></i></span>
							<ul id="liste_themes">
									
							</ul>
						</li>	
					</ul>
					<ul id="menu_modalites" class="menu">
						<li><a id="selectionner_modalite">Toutes les modalités</a><span><i class="fa fa-caret-down" style="font-size:1.2em;"></i></span>
							<ul id="liste_modalites">
									
							</ul>
						</li>
					</ul>
					</div>
					
					<div class="divTableCell">
					<h3 class="">Liste des coopérations &nbsp;:</h3>
					<div class="description cooperation" id="liste_toutes_cooperations"></div>
					</div>
					
					
				</div>
				
				<!-- Contenu de la fiche d'information sur les territoires -->
				<div class="divTable" id="fiche_territoire">
					
					<h3 class="divTableRow">Territoire</h3>
					<h2 class="territoire" id="libgeo"></h2>
					
					<div class="">
						<h3 class="">Liste des coopérations dans lequel ce territoire est impliqué&nbsp;:</h3>
						<div class="description cooperation" id="liste_cooperations"></div>
						
						<div class="retour"><img src='img/fleche.png' style='vertical-align:middle; width:20px; padding:0px 15px;'  />Retour</div>
					</div>	
				</div>
				
				<!-- Contenu de la fiche d'information sur les coopérations -->
				<div class="divTable" id="fiche_cooperation">
					
					<h3 class="divTableRow">Coopération</h3>
					<h2 class="cooperation" id="nom"></h2>
					
					<div class="divTableBody">
						<div class="divTableCell">
								<h3 class="divTableRow">Objectifs de la coopération</h3>
								<div class="divTableRow description" id="objectif"></div>
						</div>
						
						<div class="divTableCell">
								<h3 class="divTableRow">Thématiques</h3>
								<div class="divTableRow description" id="thematiques"></div>
						</div>
						
						<div class="divTableCell">
								<h3 class="divTableRow">Modalité</h3>
								<div class="divTableRow description" id="modalite"></div>
						</div>
						
						<div class="divTableCell">
								<h3 class="divTableRow">liste des territoires impliqués dans la coopération</h3>
								<div class="divTableRow description territoire" id="liste_territoires"></div>
						</div>
						
						<div class="retour"><img src='img/fleche.png' style='vertical-align:middle; width:20px; padding:0px 15px;'  />Retour</div>
					</div>	
				</div>
				
				
				<!-- Page d'infos -->
				<div class="divTable" id="divInfos">
					
					<div>
						<p><strong>Bienvenue sur la carte interactive des coopérations interterritoriales*</strong> proposée par le CGET, en lien avec France urbaine, l’AdCF, l’ANPP, l’AMRF, la FNAU et Villes de France**.</p>
						<p>Chaque coopération interterritoriale est décrite - <strong>objectifs, thématiques, modalités</strong> (ex : contrat de réciprocité, pôle métropolitain, syndicat mixte, entente, etc.) – et des documents ressources sont téléchargeables (monographies, interviews, etc.).</p>
						<p>La navigation est double :</p>
						<p>cliquez sur un territoire et accédez aux coopérations dans lesquelles il est engagé ; </p>
						<p>cliquez sur une coopération et identifiez les territoires qui y sont engagés. </p>
						<p>Un module de recherche vous permet d’<strong>accéder à toutes les coopérations recensées par thématique et par modalité.</strong></p>
						<p>N’hésitez pas à nous contacter pour que votre coopération interterritoriale figure sur la carte interactive.</p>
						<p>Bonne navigation !</p>
						<p><i>(*)= on entend par « coopérations interterritoriales » l’ensemble des démarches volontaires de plusieurs territoires visant à porter des projets et des actions en commun, par exemple sous forme d’ ententes, associations, contrats de réciprocité, autres contrats et conventions, pôles métropolitains, syndicats mixtes, GIP, SPL, SEM, etc. Elles se distinguent des coopérations au sein du bloc local (pays, PETR, EPCI etc.). </i></p>
					</div>
					
					<div id="sources" style="width:100%;">
						<p><i>Sources des données&nbsp;: <a href="https://www.cget.gouv.fr/territoires/metropoles" class="hyperlien" target="_blank">CGET, Direction des stratégories territoriales,</a> • Réalisation&nbsp;: bureau de la prospective et des études, <a href="https://cartotheque.cget.gouv.fr/cartes?filters%5Bquery%5D=interactif&current_page=1&category=&page_size=20" class="hyperlien" target="_blank">CGET service cartographie</a></i></p>
						<p><img src="img/cget.png" style="vertical-align:middle; width:70%;"/></p>
					</div>
					
					<div class="retour"><img src='img/fleche.png' style='vertical-align:middle; width:20px; padding:0px 15px;'  />Retour</div>
				
				</div>
				
					
            </div>

        </div>
    </div>
	
	<!-- Définition indicateur 
	<div id="tip">
		<p>Le <strong>potentiel financier</strong> remplace à partir de 2005 le potentiel fiscal comme élément de <strong>mesure de la richesse théorique d’une commune.</strong></p>
			</div>-->
	<!-- Bloc de la carte -->
	
	<div id="mapid"></div>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
	
    <script src="src/leaflet-sidebar.js"></script>
	<script src="src/leaflet-search.js"></script>
	<script src="src/randomColor-master/randomColor.js"></script>
	<script type="text/javascript"  src="https://unpkg.com/leaflet.vectorgrid@1.2.0"></script>
	<script type="text/javascript" src="data/296territoires.js"></script>
	<script type="text/javascript" src="data/125cooperations.js"></script>
	<script type="text/javascript" src="data/masque.js"></script>
	<script type="text/javascript" src="data/toutesCouches_gen.js"></script>
	<script type="text/javascript" src="data/cercles_drom.js"></script>
	<script type="text/javascript" src="data/chef_lieu.js"></script>
    
	<script>
			
		// Création de la carte
		var map = L.map('mapid', {maxZoom:10, minZoom:5 })
		.setView([46.5, -1.8], 6);
		map.zoomControl.setPosition('topright');
		map.attributionControl.addAttribution('<a href="https://cartotheque.cget.gouv.fr/cartes" style="text-decoration:none;" target="_blank ">CGET</a>');
			
		//Ajout du panneau latéral
		var sidebar = L.control.sidebar('sidebar').addTo(map);
		sidebar.open('home');
		
		//Reglage double-clic
		var timer = 0;
		var delay = 200;
		var prevent = false;
		
		//Definitions variables globales
		var theme = "th00"; 
		var modalite = "m000";
		
/* COULEURS - STYLES - LEGENDE */
		
		//une couleur unique pour chaque territoire
		var couleur;
		var hue = '';
		function getColor(type) {
			if (type == "territoire") {hue = 'blue';}
			else if (type == "cooperation") {hue = 'orange';}
			couleur = randomColor({ 
				hue : hue,
				luminosity: 'bright', //bright light dark
				format: 'hex' // rgb rgba rgbArray hsl hsla hslArray hex
				});
			return couleur;
		}
		
/* CREATION DES COUCHES */		
		
		//Niveaux d'affichage des couches
		map.createPane('fond');
		map.getPane('fond').style.zIndex = 500;
		map.createPane('contour');
		map.getPane('contour').style.zIndex = 500;
		map.createPane('cercles');
		map.getPane('cercles').style.zIndex = 510;
		map.createPane('cooperations');
		map.getPane('cooperations').style.zIndex = 520;
		map.createPane('territoires');
		map.getPane('territoires').style.zIndex = 523;
		map.createPane('metCible2');
		map.getPane('metCible2').style.zIndex = 530;
		map.createPane('metCible');
		map.getPane('metCible').style.zIndex = 540;
		map.createPane('lines');
		map.getPane('lines').style.zIndex = 550;
		map.createPane('labels');
		map.getPane('labels').style.zIndex = 560;
		
		
		//Couches du fond de carte
		Cache = L.geoJSON(JS_masque, {color: "#007282", weight: 0, opacity: 1, fillOpacity: 1, pane: "fond"}).addTo(map);
		Cercles_drom = L.geoJSON(JS_drom, {color: "#ffffff", weight: 0.9, opacity: 1, fillOpacity: 0, pane: "cercles"}).addTo(map);
		
		Fond_Regions = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="région"},
			style : {weight: 0, opacity: 1, fillOpacity: 1, fillColor:"#9ac2c3", pane: "fond"}
			}).addTo(map);
		
		Contour_Regions = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="région"},
			style : {color: "#ffffff", weight: 1.3, opacity: 0.5, fillOpacity: 0, pane: "contour"}
			}).addTo(map);
		
		Departements = L.geoJSON(JS_tout, {
			filter: function(feature, layer) {return feature.properties.type=="départemen"},
			style: {color: "#ffffff", weight: 0.5, opacity: 0.5, fillOpacity: 0, pane: "contour"}
			}).addTo(map);
		
		//Création des labels
		var createLabelIcon = function(labelClass,labelText){
		return L.divIcon({ 
		className: labelClass,
		html: labelText
		})
		}
		
		//Label Regions
		labelsReg = L.geoJSON(JS_chef_lieu, {
				pointToLayer: function(feature, latlng) {
					return L.marker(latlng,{icon:createLabelIcon("labelClassReg", feature.properties.libgeom),pane:'labels', interactive: false})
				},
				filter : function(feature, layer) {
                return feature.properties.STATUT == "région";
				}		
		}).addTo(map)
		
		//Label Departements
		labelsDep = L.geoJSON(JS_chef_lieu, {
				pointToLayer: function(feature, latlng) {
					return L.marker(latlng,{icon:createLabelIcon("labelClassDep", feature.properties.libgeom),pane:'labels', interactive: false})
				},
				filter : function(feature, layer) {
                return feature.properties.STATUT == "département";
				}		
		})
		
		//Label Canton
		labelsCan = L.geoJSON(JS_chef_lieu, {
				pointToLayer: function(feature, latlng) {
					return L.marker(latlng,{icon:createLabelIcon("labelClassCan", feature.properties.libgeom),pane:'labels', interactive: false})
				},
				filter : function(feature, layer) {
                return feature.properties.STATUT == "sous-prefecture";
				}		
		})
		
		//Territoires
		Territoires = L.geoJSON(JS_territoires, {
			//filter: function(feature, layer) {return feature.properties.type=="départemen"},
			style: function(feature){return { color: "white", weight: 0.5, opacity: 0.5, fillOpacity: 0, pane: "territoires", interactive:false, fillColor: getColor("territoire")};},
			onEachFeature: function(feature, layer) {		
				layer.bindTooltip(feature.properties.nom, {className: 'TooltipsTerr Tooltips', direction: "center", sticky:true});
				layer.on('click', function(e) {	
					showFiche(feature.properties, "territoire"); 
					geometrieCible(e.target._latlngs, "territoire");
					polylineCoopHeavy.clearLayers();
					e.preventDefault();					
					});	
				layer.on('mouseover', function(e) {	
					geometrieCibleHover(e.target, 'objet', "territoire"); 
					});	
				layer.on('mouseout', function(e) {	
					if(metCibHover) {map.removeLayer(metCibHover);}
					terrLayer.clearLayers();
					});	
				}
			})
			.addTo(map);
		

		var coopLayer = new L.layerGroup();
		coopLayer.addTo(map);
		
		//Cooperations
		Cooperations = L.geoJSON(JS_cooperations, {
			style: function(feature){return { color: getColor("cooperation"), weight: 2.5, opacity: 1, fillOpacity: 1, pane: "cooperations", fillColor: getColor("cooperation")};},
			onEachFeature: function(feature, layer) {		
				layer.bindTooltip(feature.properties.nom, {className: 'TooltipsCoop Tooltips', direction: "center", sticky:true});
				layer.on('click', function(e) {	
					showFiche(feature.properties.id_coop, "cooperation"); 
					geometrieCible(e.target._latlngs, "cooperation");
					//polylineCoopHeavy.clearLayers();
					e.preventDefault();					
					});	
				layer.on('mouseover', function(e) {	
					geometrieCibleHover(e.target, 'objet', "cooperation"); 
					});	
				layer.on('mouseout', function(e) {	
					if(metCibHover) {map.removeLayer(metCibHover);}
					terrLayer.clearLayers();
					});	
				layer.addTo(coopLayer);
				}
			})
			//.addTo(map);
		
		//Aller chercher le tableau des correspondances
		var listeTerrCoop = [];
		function creerListeTerrCoop() {
			fetch("data/terr_coop.json")
				.then(response=>response.json())
				.then(response=>{
					for (var i = 0; i < response.length; i++) {
						listeTerrCoop.push(response[i])
						}
					});
		}
		creerListeTerrCoop();
		
		//Aller chercher le tableau des coopérations et remplir la liste des coopérations du module recherche avec
		var listeCooperations = [];
		function creerCoop() {
			for (var i = 0; i < JS_cooperations.features.length; i++) {
				listeCooperations.push(JS_cooperations.features[i].properties.nom);
				document.getElementById("liste_toutes_cooperations").innerHTML +=
					"<div class='liste'" +
					"onClick='map.flyToBounds(returnCoordsCoop(\""+JS_cooperations.features[i].properties.id_coop+"\"), {padding:[20,20]}); showFiche(\""+JS_cooperations.features[i].properties.id_coop+"\", \"cooperation\"); drawLines(\""+JS_cooperations.features[i].properties.id_coop+"\", \"heavy\"); polylineCoopHeavy.clearLayers();'" +
					"onmouseover='drawLines(\""+JS_cooperations.features[i].properties.id_coop+"\", \"thin\"); terrImpliques(\""+JS_cooperations.features[i].properties.id_coop+"\")'" +
					"onmouseout='polylineCoopThin.clearLayers(); terrLayer.clearLayers();'>" +
					"&rarr; "+JS_cooperations.features[i].properties.nom+"</div>";
				}
		}
		creerCoop();
		
		//Aller chercher le tableau des thèmes et remplir le menu déroulant avec
		var listeThemes = [];
		function creerThemes() {
			listeThemes = [];
			fetch("data/liste_themes.json")
				.then(response=>response.json())
				.then(response=>{
					for (var i = 0; i < response.length; i++) {
						listeThemes.push(response[i]);
						document.getElementById("liste_themes").innerHTML +=
										"<li onClick='filtre(\""+response[i].id_theme+"\", \""+modalite+"\");document.getElementById(\"selectionner_theme\").innerHTML = \""+response[i].nom_theme+"\";' >"+
										"<a href='#'>"+response[i].nom_theme+"</a></li>";
						}	
					});
		}
		creerThemes();
		
		//Aller chercher le tableau des modalités et remplir le menu déroulant avec
		var listeModalites = [];
		function creerModalites() {
			listeModalites = [];
			fetch("data/liste_modalites.json")
				.then(response=>response.json())
				.then(response=>{
					for (var i = 0; i < response.length; i++) {
						listeModalites.push(response[i]);
						document.getElementById("liste_modalites").innerHTML +=
										"<li onClick='filtre(\""+theme+"\", \""+response[i].id_modalite+"\"); console.log(\""+theme+"\"); document.getElementById(\"selectionner_modalite\").innerHTML = \""+response[i].nom_modalite+"\";'>"+
										"<a href='#'>"+response[i].nom_modalite+"</a></li>";
						}	
					});
		}
		creerModalites();
		
		//couches d'action de sélection
		var metCib = [];
		function geometrieCible(e, terrcoop){ 
			if(metCib) {map.removeLayer(metCib);}
			var fillColor;
			if (terrcoop == "territoire"){fillColor="green"} else if (terrcoop == "cooperation"){fillColor="yellow"};
			metCib = L.polygon(e, {interactive:false, opacity: 1, fillOpacity: 0.8, fillColor: fillColor, weight: 1, color: '#333333', pane: "metCible2"}).addTo(map);
			console.log(metCib);
		}
		
		var metCibHover = [];
		function geometrieCibleHover(e, type, terrcoop){ 
			if(metCibHover) {map.removeLayer(metCibHover);}
			var fillColor;
			if (terrcoop == "territoire"){fillColor="blue"} else if (terrcoop == "cooperation"){fillColor="orange"}
			if (type == 'objet'){metCibHover = L.polygon(e._latlngs, {fillOpacity: 1, fillColor: fillColor, interactive:false, color: 'white',pane: "metCible", weight:2}).addTo(map);}
			else if (type == 'xy'){ metCibHover = L.polygon(e, {fillOpacity: 1, fillColor: fillColor, interactive:false, color: 'white',pane: "metCible", weight:2}).addTo(map);}
			//terrImpliques(e.feature.properties.id_terr);
		}
		
		//Afficher la connexion entre les territoires
		var terrLayer = new L.layerGroup();
		function terrImpliques(e) {
			//Lire la table des correspondances pour tirer la liste des coopérations dans lesquelles le territoire est impliqué
			for (var i = 0; i < listeTerrCoop.length; i++) {
				if (e == listeTerrCoop[i].id_coop) {
					polygon = new L.polygon(returnCoords(listeTerrCoop[i].id_territoire), {fillOpacity: 1, fillColor: 'orange', interactive:false, pane: "metCible", weight:0.2, color: 'white'});
					polygon.addTo(terrLayer);
				}
				terrLayer.addTo(map);
			}
		}
		
		//aficher les liens inter-territoriaux d'une coopération
		var centroidArray = [];
		var polyline = {};
		var polylineCoopHeavy = new L.layerGroup();
		polylineCoopHeavy.addTo(map);
		var polylineCoopThin = new L.layerGroup();
		polylineCoopThin.addTo(map);
		function drawLines(e,type) {
			centroidArray = [];
			for (var i = 0; i < listeTerrCoop.length; i++) {
				if (e == listeTerrCoop[i].id_coop){
					centroidArray.push(returnCentroid(listeTerrCoop[i].id_territoire));
					
					terrImpliques(listeTerrCoop[i].id_territoire);
					}
				}
				if(type=="thin"){
					polylineCoopThin.clearLayers();
					polyline[e] = L.polyline(centroidArray, {color:"red", weight:2, opacity:0.7, pane: "lines"});
					polyline[e].addTo(polylineCoopThin);	
					}
				else if (type=="heavy"){
					polylineCoopHeavy.clearLayers();
					polyline[e] = L.polyline(centroidArray, {color:"red", weight:3, pane: "lines"});
					polyline[e].addTo(polylineCoopHeavy);
					polyline[e].on('click', function(){showCoop(e,"cooperation");});
					//polyline[e].bindTooltip(returnCoopObject(e).nom, {className: 'TooltipsCoop Tooltips', direction: "center", sticky: "true"});
					}
				polyline[e].properties = {};
				polyline[e].properties.id_coop = e;
		}
		
		
		
		
/* FICHES TERRITOIRES ET COOPERATIONS */
		
		//Création d'une fiche
		function showFiche(e, couche) {
			if (document.getElementById('sidebar').classList.contains('collapsed')){sidebar.open('home');}
			document.getElementById('defaut').style.display = "none";
			document.getElementById("divInfos").style.display = "none";
			
			polylineCoopHeavy.clearLayers();
			//if(metCib) {map.removeLayer(metCib);}
			//if(metCibHover) {map.removeLayer(metCibHover);}
			
			//Fiche territoire
			if (couche=="territoire") { 
				document.getElementById('fiche_territoire').style.display = "block";
				document.getElementById('fiche_cooperation').style.display = "none";
				//Remplissage de la popup
					//Infos sur le territoire
					document.getElementById('libgeo').innerHTML = jointure(e, 'coop-terr', 'nom_terr');	
				
				//Liste des coopérations
					document.getElementById('liste_cooperations').innerHTML = "<div>";
					for (var i = 0; i < listeTerrCoop.length; i++) {
						if(e == listeTerrCoop[i].id_territoire){
							document.getElementById("liste_cooperations").innerHTML +=
								"<div class='liste	'" +
								"onclick='showFiche(\"" +listeTerrCoop[i].id_coop+"\", \"cooperation\" ); drawLines(\""+listeTerrCoop[i].id_coop+"\", \"heavy\"); geometrieCible(\"" +listeTerrCoop[i].id_coop+"\", \"cooperation\"); '" +
								"onmouseover='drawLines(\""+listeTerrCoop[i].id_coop+"\", \"thin\"); terrImpliques(\""+listeTerrCoop[i].id_coop+"\")'" +
								"onmouseout='polylineCoopThin.clearLayers(); terrLayer.clearLayers();'>" +
								"&rarr; " + jointure(listeTerrCoop[i].id_coop, 'terr-coop' ,'nom') + "</div>" ;
						}
					}
					document.getElementById('liste_cooperations').innerHTML += "</div>";
			}
			
			//Fiche coopération
			if (couche == "cooperation") { 
				document.getElementById('fiche_territoire').style.display = "none";
				document.getElementById('fiche_cooperation').style.display = "block";
				
				//Infos sur la coopération
				document.getElementById('nom').innerHTML = jointure(e, 'terr-coop' ,"nom");
				document.getElementById('objectif').innerHTML = jointure(e, 'terr-coop' ,"objectif");
				document.getElementById('thematiques').innerHTML = jointure(e, 'terr-coop' ,"thematique");
				document.getElementById('modalite').innerHTML = jointure(e, 'terr-coop' ,"modalite");
			
				//Liste des territoires impliqués
				document.getElementById('liste_territoires').innerHTML = "<div>";
				for (var i = 0; i < listeTerrCoop.length; i++) {
					if(e == listeTerrCoop[i].id_coop){
						document.getElementById("liste_territoires").innerHTML +=
						"<div class='liste'" +
						"onMouseover='geometrieCibleHover(returnCoords(\""+listeTerrCoop[i].id_territoire+"\"), \"xy\", \"territoire\");'" +
						"onMouseout='map.removeLayer(metCibHover);'" +
						"onclick='showFiche(\""+listeTerrCoop[i].id_territoire+"\", \"territoire\"); geometrieCible(returnCoords(\""+listeTerrCoop[i].id_territoire+"\"), \"territoire\"); '>" +
						"&rarr; " + jointure(listeTerrCoop[i].id_territoire, 'coop-terr', 'nom_terr') +"</div>" ;
					}
				}
				document.getElementById('liste_territoires').innerHTML += "</div>";
			}
		
		}
		
		//crée le centroïde à partir de coordonnées latlngs
		var centroid;
		function returnCentroid(e) {
			Territoires.eachLayer(function(layer){
				if(e == layer.feature.properties.id_terr){
					centroid = layer.getBounds().getCenter();
				}
			});
			return centroid;
		}
		
	
/* ACTIONS */
		
		function test() {
			console.log(theme);
		}
		
		// Filtre les coopérations en fonction du thème choisi
		function filtre(theme_choisi, modalite_choisie) {
			//console.log("envoi : theme choisi "+theme_choisi+" - modalite choisie "+modalite_choisie);
			polylineCoopHeavy.clearLayers();
			document.getElementById("liste_toutes_cooperations").innerHTML = "";
			
			theme = theme_choisi;
			//console.log ("theme"+theme);
			modalite = modalite_choisie;
			
			coopLayer.clearLayers();
			//console.log("avant boucle : theme "+theme+" - modalite "+modalite);
			if ( theme == 'th00' ) {
					if (modalite == 'm000') {
						Cooperations.eachLayer(function(layer){
								console.log(layer._latlngs);
								document.getElementById("liste_toutes_cooperations").innerHTML +=
									"<li class='liste'" +
									"onclick='showFiche(\"" +layer.feature.properties.id_coop+"\", \"cooperation\"); drawLines(\""+layer.feature.properties.id_coop+"\", \"heavy\"); '" +
									"onmouseover='drawLines(\""+layer.feature.properties.id_coop+"\", \"thin\"); terrImpliques(\""+layer.feature.properties.id_coop+"\")'" +
									"onmouseout='polylineCoopThin.clearLayers(); terrLayer.clearLayers();'>" +
									"&rarr; " + layer.feature.properties.nom + "</li>" ;
								layer.addTo(coopLayer);
							});
						}
					else {
						//console.log("tous les themes : theme "+theme+" - modalite "+modalite);
						Cooperations.eachLayer(function(layer){
							if (layer.feature.properties.id_modalite == modalite) {
								document.getElementById("liste_toutes_cooperations").innerHTML +=
									"<li class='liste'" +
									"onclick='showFiche(\"" +layer.feature.properties.id_coop+"\", \"cooperation\"); drawLines(\""+layer.feature.properties.id_coop+"\", \"heavy\");'" +
									"onmouseover='drawLines(\""+layer.feature.properties.id_coop+"\", \"thin\"); terrImpliques(\""+layer.feature.properties.id_coop+"\")'" +
									"onmouseout='polylineCoopThin.clearLayers(); terrLayer.clearLayers();'>" +
									"&rarr; " + layer.feature.properties.nom + "</li>" ;
								layer.addTo(coopLayer);
								}
							});
						}
				}		
			else if (modalite == 'm000') {
				Cooperations.eachLayer(function(layer){
						if (layer.feature.properties.id_theme.includes(theme)) {
							document.getElementById("liste_toutes_cooperations").innerHTML +=
								"<li class='liste'" +
								"onclick='showFiche(\"" +layer.feature.properties.id_coop+"\", \"cooperation\"); drawLines(\""+layer.feature.properties.id_coop+"\", \"heavy\");'" +
								"onmouseover='drawLines(\""+layer.feature.properties.id_coop+"\", \"thin\"); terrImpliques(\""+layer.feature.properties.id_coop+"\")'" +
								"onmouseout='polylineCoopThin.clearLayers(); terrLayer.clearLayers();'>" +
								"&rarr; " + layer.feature.properties.nom + "</li>" ;
							layer.addTo(coopLayer);
							}
					});
				}
			else {
				//console.log("2 filtres : theme "+theme+" - modalite "+modalite);
				Cooperations.eachLayer(function(layer){
					if (layer.feature.properties.id_theme.includes(theme) && layer.feature.properties.id_modalite == modalite) {
						document.getElementById("liste_toutes_cooperations").innerHTML +=
							"<li class='liste'" +
							"onclick='showFiche(\"" +layer.feature.properties.id_coop+"\", \"cooperation\"); drawLines(\""+layer.feature.properties.id_coop+"\", \"heavy\"); '" +
							"onmouseover='drawLines(\""+layer.feature.properties.id_coop+"\", \"thin\"); terrImpliques(\""+layer.feature.properties.id_coop+"\")'" +
							"onmouseout='polylineCoopThin.clearLayers(); terrLayer.clearLayers();'>" +
							"&rarr; " + layer.feature.properties.nom + "</li>" ;
						layer.addTo(coopLayer);
					}
				});
			}

		
		}
		
		
		//Retourne les coordonnées à partir d'un identifiant de territoire
		var coords;
		function returnCoords(e) {
			Territoires.eachLayer(function(layer){
				if (layer.feature.properties.id_terr == e) {
					coords = layer._latlngs;
					}
			});
			return coords;
		}
		
		function returnCoordsCoop(e) {
			Cooperations.eachLayer(function(layer){
				if (layer.feature.properties.id_coop == e) {
					coords = layer._latlngs;
					}
			});
			return coords;
		}
		
		//Retourne l'objet coopérations à partir de l'identifiant de la coopération
		var coopObjet;
		function returnCoopObject(e) {
			for (var i = 0; i < listeCooperations.length; i++) {
				if(e == listeCooperations[i].id_coop){
					coopObjet = listeCooperations[i];
					}
			}
			return coopObjet;
		}
		
		//Jointures liste des coopérations et tableau de correspondances
		function jointure(e,sens,champ) {
		var resultat ;
			if (sens == "terr-coop" ) {
				Cooperations.eachLayer(function(layer){
					if(e == layer.feature.properties.id_coop){
						if (champ == "nom"){resultat = layer.feature.properties.nom}
						else if (champ == "objectif"){resultat = layer.feature.properties.objectif}
						//if (champ == "liste_territoire"){resultat = layer.feature.properties.liste_territoire;alert("liste"+layer.feature.properties.nom)}
						else if (champ == "thematique"){resultat = layer.feature.properties.thematique}	
						else if (champ == "modalite"){resultat = layer.feature.properties.modalite}
					}
				});
			}
			if (sens == "coop-terr" ) {
				Territoires.eachLayer(function(layer){
					if(e == layer.feature.properties.id_terr){
						if (champ == "nom_terr"){resultat = layer.feature.properties.nom}
					}
				});
			}	
		return resultat ;				
		}
		
		
		// Fonctions générales de navigation
		function resetView() {
			map.setView([46.5, -1.8], 6);		
		}
		
		function resetMap () {
			sidebar.open('home');
			}
			
		function retourAcceuil () {
			resetView();
			resetMap ();
			document.getElementById('fiche_territoire').style.display = "none";
			document.getElementById('defaut').style.display = "block";
			document.getElementById('fiche_cooperation').style.display = "none";
			document.getElementById("divInfos").style.display = "none";
			polylineCoopHeavy.clearLayers();
		}
		
		//Action au clic sur "retour"
		var boutons_retour = document.getElementsByClassName("retour");
		for (var i = 0; i < boutons_retour.length; i++) {
			boutons_retour[i].addEventListener('click', retourAcceuil, false);
		}
		
		//Action au clic sur la carte
		map.on('click', function(e) { 
			if(metCib) {map.removeLayer(metCib);}
			if(metCibHover) {map.removeLayer(metCibHover);}
			polylineCoopHeavy.clearLayers();
			//retourAcceuil();
			event.stopPropagation();
			
			});
		
		//Action au clic sur "home"
		document.getElementById("logo").addEventListener("click", function(event){
			event.stopPropagation();
			retourAcceuil();
		});
		
		//Action au clic sur "recherche"
		document.getElementById("info").addEventListener("click", function(event){
			event.stopPropagation();
			document.getElementById("divInfos").style.display = "block";
			document.getElementById('fiche_territoire').style.display = "none";
			document.getElementById('defaut').style.display = "none";
			document.getElementById('fiche_cooperation').style.display = "none";
		});
		
		//Affichage des labels suivant le zoom
		map.on('zoomend', function() {
			var zoom = map.getZoom();
			if (zoom < 8) {map.removeLayer(labelsDep); map.removeLayer(labelsCan);}
			else if (zoom >= 8 && zoom < 9) { map.addLayer(labelsDep); map.removeLayer(labelsCan);}
			else if (zoom >= 9) {map.addLayer(labelsDep);map.addLayer(labelsCan);}
		});

/* BARRES DE RECHERCHE */	
		
		//Barre de recherche n°1 (panneau latéral)
		var Recherche = L.layerGroup([Territoires, coopLayer]);
		
		var searchControl = new L.control.search({
			layer: Recherche,
			initial: false,
			propertyName: "nom",
			marker: false,
			moveToLocation: function(latlng, title, map) {
				map.setView(latlng, 8);
			}
		})
		
		searchControl.on('search:locationfound', function(e) {
			if(metCib) {map.removeLayer(metCib);}
			geometrieCible(e.layer._latlngs);
			showFiche(e.layer.feature.properties, "territoire");
		});
		
		map.addControl(searchControl);
		
		//Déplacement du controle de recherche n°1
		var htmlObject = searchControl.getContainer();
		var a = document.getElementById('boiteRecherche');
		function setParent(el, newParent)
		{newParent.appendChild(el);}
		setParent(htmlObject, a);
		
		//Barre de recherche n°2 (en haut à droite)
		var searchControl2 = new L.control.search({
			layer: Recherche,
			initial: false,
			position:'topright',
			propertyName: 'nom',
			collapsed: true,
			marker: false,
			moveToLocation: function(latlng, title, map) {
				map.setView(latlng, 8);
			}
		})
		
		searchControl2.on('search:locationfound', function(e) {
			if(metCib) {map.removeLayer(metCib);}
			geometrieCible(e.layer._latlngs);
			showFiche(e.layer.feature.properties, "territoire");
		});
		
		map.addControl(searchControl2);	
		
		//map.removeLayer(Cooperations);
		
   </script>
	
</body>

</html>
